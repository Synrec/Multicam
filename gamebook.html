<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>div { max-width: 600px; padding: 1rem; margin: auto; color: #444444 } div:nth-last-child(2n+3) { background-color: #eeeeee }</style>
<script>
const scenes = {};
const variables = {};
const replacements = {};

function createScene(no, event) {
    if (event) {
        event.preventDefault();
        if (!document.body.lastChild.style.height) document.body.lastChild.style.height = "100vh";
        if (event.target.parentNode !== document.body.lastChild.previousSibling) return;
    }
    let choiceState = "initial";
    const replaceRe = new RegExp(`(${Object.keys(replacements).join("|") || "0^"})`, "g");
    const replaceFn = text => text.replace(replaceRe, (_, key) => replacements[key]);
    const text = scenes[no].split("\n").map(line => {
        let match = null;
        if (match = line.match(/^\s*(\S+)\s+<=\s*$/)) {
            const onchange = `if (event.target.parentNode === document.body.lastChild.previousSibling) replacements['${match[1]}'] = event.target.value`;
            return `<input type="text" value="${replacements[match[1]] ?? match[1]}" onchange="${onchange}">`;
        }
        if (match = line.match(/^\s*(\S+)\s+(:|\+|-)([Dd]?)(\d+)\s*$/)) {
            const [, variable, operator, dice, value] = match;
            variables[variable] ??= 0;
            const delta = dice ? Math.floor(Math.random() * value + 1) : +value;
            if (operator === ":") variables[variable] = delta;
            if (operator === "+") variables[variable] += delta;
            if (operator === "-") variables[variable] -= delta;
            return `${replaceFn(variable)}:${variables[variable]} (${operator}${dice}${value}${dice ? ` => ${operator === "-" ? -delta : delta}` : ""})`;
        }
        if (match = line.match(/^\s*(\S+)\s+(:|\+|-)(\S+)\s*$/)) {
            const [, variable, operator, value] = match;
            variables[variable] ??= 0;
            variables[value] ??= 0;
            const delta = variables[value];
            if (operator === ":") variables[variable] = delta;
            if (operator === "+") variables[variable] += delta;
            if (operator === "-") variables[variable] -= delta;
            return `${replaceFn(variable)}:${variables[variable]} (${operator}${replaceFn(value)} => ${operator === "-" ? -delta : delta})`;
        }
        if (match = line.match(/^.*?\S+\s+#(\d+)\s*(\S+)\s+(=|<|>|<=|>=)(-?\d+)\s*$/)) {
            const [, no, variable, operator, value] = match;
            let meet = false;
            if ((operator[0] === "=" || operator[1] === "=") && variables[variable] === +value) meet = true;
            if (operator[0] === "<" && variables[variable] < +value) meet = true;
            if (operator[0] === ">" && variables[variable] > +value) meet = true;
            if (choiceState === "forced" || !meet) return replaceFn(line) + "<br>";
            if (choiceState === "initial") choiceState = "forced";
            return `<a href="#${no}" onclick="createScene(${no}, event)">${replaceFn(line)}</a><br>`;
        }
        if (match = line.match(/^.*?\S+\s+#(\d+)\s*$/)) {
            if (choiceState === "forced") return replaceFn(line) + "<br>";
            if (choiceState === "initial") choiceState = "selectable";
            return `<a href="#${match[1]}" onclick="createScene(${match[1]}, event)">${replaceFn(line)}</a><br>`;
        }
        return replaceFn(line);
    }).join("<br>");
    document.body.lastChild.insertAdjacentHTML("beforebegin", `<div>${text}</div>`);
    scrollBy(0, document.body.lastChild.previousSibling.getBoundingClientRect().top);
}

document.addEventListener("DOMContentLoaded", () => {
    let key = 0;
    document.body.textContent.split("\n").forEach(line => {
        let match = null;
        if (match = line.match(/^\s*#(\d+)\s*$/)) {
            if (scenes[key]) scenes[key] = scenes[key].trim();
            key = match[1];
            scenes[key] = "";
        }
        scenes[key] += line + "\n";
    });
    scenes[key] = scenes[key].trim();
    if (location.protocol === "file:") {
        document.body.innerHTML = "<div></div>";
    } else {
        const downloadStr = `<!DOCTYPE html>\n<html>\n<head>${document.head.innerHTML}</head>\n<body>${document.body.textContent.slice(0, -1)}</body>\n</html>`;
        const downloadFile = new Blob([downloadStr], { type: "text/html" });
        document.body.innerHTML = `<div><a href="${URL.createObjectURL(downloadFile)}" download="${document.title}.html">この作品をダウンロード</a></div><div></div>`;
    }
    createScene(1);
});
</script>
<title>ゲームブック</title>
</head>
<body>
#1

「いらっしゃい！カード遊びで賭けをしていかないかい？」

お金 :100

【ルール】
まずあなたがトランプのカード（１～１３）を一枚引く。
ディーラーも一枚カードを引いて、場に伏せておく。
あなたは自分のカードの数字を見て、場のカードがそれより高いか低いかを予想する。
当たればお金が２倍になる。

やる #3
やらない #2



#2

完。

お金 :お金



#3

「よし、じゃあ一枚引いてくれ！」

自分のカード :D13

「俺も一枚引くぜ！」
場のカードは伏せられた。
さて、場のカードは自分のカードより高いだろうか…？

高い #4
低い #5



#4

「場のカード、オープン！」
場のカード :D13
場のカード -自分のカード

予想的中！ #6 場のカード >0
引き分け #7 場のカード =0
はずれ… #8



#5

「場のカード、オープン！」
場のカード :D13
場のカード -自分のカード

予想的中！ #6 場のカード <0
引き分け #7 場のカード =0
はずれ… #8



#6

「やるな！！！」

お金 +お金

もう一度やる #3
おわる #2



#7

「引き分けだから、お金の移動はなしな。」

お金 :お金

もう一度やる #3
おわる #2



#8

「残念！お金没収」

お金 -100

お金がないので終わり #2 お金 <=0
もう一度やる #3
おわる #2
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>div { max-width: 600px; padding: 1rem; margin: auto; color: #444444 } div:nth-last-child(2n+3) { background-color: #eeeeee }</style>
<script>
const scenes = {};
const variables = {};
const replacements = {};

function createScene(no, event) {
    if (event) {
        event.preventDefault();
        if (!document.body.lastChild.style.height) document.body.lastChild.style.height = "100vh";
        if (event.target.parentNode !== document.body.lastChild.previousSibling) return;
    }
    let choiceState = "initial";
    const replaceRe = new RegExp(`(${Object.keys(replacements).join("|") || "0^"})`, "g");
    const replaceFn = text => text.replace(replaceRe, (_, key) => replacements[key]);
    const text = scenes[no].split("\n").map(line => {
        let match = null;
        if (match = line.match(/^\s*(\S+)\s+<=\s*$/)) {
            const onchange = `if (event.target.parentNode === document.body.lastChild.previousSibling) replacements['${match[1]}'] = event.target.value`;
            return `<input type="text" value="${replacements[match[1]] ?? match[1]}" onchange="${onchange}">`;
        }
        if (match = line.match(/^\s*(\S+)\s+(:|\+|-)([Dd]?)(\d+)\s*$/)) {
            const [, variable, operator, dice, value] = match;
            variables[variable] ??= 0;
            const delta = dice ? Math.floor(Math.random() * value + 1) : +value;
            if (operator === ":") variables[variable] = delta;
            if (operator === "+") variables[variable] += delta;
            if (operator === "-") variables[variable] -= delta;
            return `${replaceFn(variable)}:${variables[variable]} (${operator}${dice}${value}${dice ? ` => ${operator === "-" ? -delta : delta}` : ""})`;
        }
        if (match = line.match(/^\s*(\S+)\s+(:|\+|-)(\S+)\s*$/)) {
            const [, variable, operator, value] = match;
            variables[variable] ??= 0;
            variables[value] ??= 0;
            const delta = variables[value];
            if (operator === ":") variables[variable] = delta;
            if (operator === "+") variables[variable] += delta;
            if (operator === "-") variables[variable] -= delta;
            return `${replaceFn(variable)}:${variables[variable]} (${operator}${replaceFn(value)} => ${operator === "-" ? -delta : delta})`;
        }
        if (match = line.match(/^.*?\S+\s+#(\d+)\s*(\S+)\s+(=|<|>|<=|>=)(-?\d+)\s*$/)) {
            const [, no, variable, operator, value] = match;
            let meet = false;
            if ((operator[0] === "=" || operator[1] === "=") && variables[variable] === +value) meet = true;
            if (operator[0] === "<" && variables[variable] < +value) meet = true;
            if (operator[0] === ">" && variables[variable] > +value) meet = true;
            if (choiceState === "forced" || !meet) return replaceFn(line) + "<br>";
            if (choiceState === "initial") choiceState = "forced";
            return `<a href="#${no}" onclick="createScene(${no}, event)">${replaceFn(line)}</a><br>`;
        }
        if (match = line.match(/^.*?\S+\s+#(\d+)\s*$/)) {
            if (choiceState === "forced") return replaceFn(line) + "<br>";
            if (choiceState === "initial") choiceState = "selectable";
            return `<a href="#${match[1]}" onclick="createScene(${match[1]}, event)">${replaceFn(line)}</a><br>`;
        }
        return replaceFn(line);
    }).join("<br>");
    document.body.lastChild.insertAdjacentHTML("beforebegin", `<div>${text}</div>`);
    scrollBy(0, document.body.lastChild.previousSibling.getBoundingClientRect().top);
}

document.addEventListener("DOMContentLoaded", () => {
    let key = 0;
    document.body.textContent.split("\n").forEach(line => {
        let match = null;
        if (match = line.match(/^\s*#(\d+)\s*$/)) {
            if (scenes[key]) scenes[key] = scenes[key].trim();
            key = match[1];
            scenes[key] = "";
        }
        scenes[key] += line + "\n";
    });
    scenes[key] = scenes[key].trim();
    if (location.protocol === "file:") {
        document.body.innerHTML = "<div></div>";
    } else {
        const downloadStr = `<!DOCTYPE html>\n<html>\n<head>${document.head.innerHTML}</head>\n<body>${document.body.textContent.slice(0, -1)}</body>\n</html>`;
        const downloadFile = new Blob([downloadStr], { type: "text/html" });
        document.body.innerHTML = `<div><a href="${URL.createObjectURL(downloadFile)}" download="${document.title}.html">この作品をダウンロード</a></div><div></div>`;
    }
    createScene(1);
});
</script>
<title>ゲームブック</title>
</head>
<body>
#1

魔王が現れた！

勇者のHP :10
勇者の攻撃力 :10
炎の杖 :1

魔王のHP :100


次へ #2



#2

ターン +1
どうする？


イベント発生 #10 ターン =3
殴る #4
炎の杖を使う #5 炎の杖 >=1



#3

死。



#4

勇者の攻撃！
魔王のHP -勇者の攻撃力
魔王のHP -D3


クリア！ #12 魔王のHP <=0
魔王のターンへ #6

#5

勇者は炎の杖を使った。
３つの火の玉が魔王を襲う！

魔王のHP -D20
魔王のHP -D20
魔王のHP -D20

炎の杖は役目を終えて砕け散った！

炎の杖 -1


クリア！ #12 魔王のHP <=0
魔王のターンへ #6

#6

魔王のターン！行動を決定しています…
魔王の行動 :D6


蹴る #7 魔王の行動 <4
斬る #8 魔王の行動 <5
笑う #9

#7

魔王が蹴ってきた！
勇者のHP -D3


死亡… #3 勇者のHP <=0
勇者のターンへ #2

#8

魔王が斬ってきた！
勇者のHP -4


死亡… #3 勇者のHP <=0
勇者のターンへ #2

#9

魔王が笑ってきた！
…しかしなにもおこらなかった。


死亡… #3 勇者のHP <=0
勇者のターンへ #2

#10

魔王「ほう。今度の勇者はなかなか骨があるな」

魔王「貴様！名を名乗れ！！！」

勇者である、あなたの名前は？
勇者 <=

決定 #11

#11

魔王「勇者か。良い名前である」

次へ #2

#12

魔王「ぐわああああ」

完。
</body>
</html>